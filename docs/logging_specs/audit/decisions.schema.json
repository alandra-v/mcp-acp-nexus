{
  "$defs": {
    "MatchedRuleLog": {
      "additionalProperties": false,
      "description": "Matched rule info for decision trace logging.\n\nProvides context about which rules matched and why they were\nevaluated in a particular order (HITL > DENY > ALLOW).",
      "properties": {
        "id": {
          "title": "Id",
          "type": "string"
        },
        "effect": {
          "enum": [
            "allow",
            "deny",
            "hitl"
          ],
          "title": "Effect",
          "type": "string"
        },
        "description": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "title": "Description"
        }
      },
      "required": [
        "id",
        "effect"
      ],
      "title": "MatchedRuleLog",
      "type": "object"
    }
  },
  "additionalProperties": false,
  "description": "One policy decision log entry (audit/decisions.jsonl).\n\nLogged on every policy evaluation for forensics and debugging.\nIncludes discovery bypasses for complete audit trail.\n\nNote: 'time' is None when created, populated by ISO8601Formatter during logging.",
  "properties": {
    "time": {
      "anyOf": [
        {
          "type": "string"
        },
        {
          "type": "null"
        }
      ],
      "default": null,
      "description": "ISO 8601 timestamp, added by formatter during serialization",
      "title": "Time"
    },
    "sequence": {
      "anyOf": [
        {
          "type": "integer"
        },
        {
          "type": "null"
        }
      ],
      "default": null,
      "description": "Monotonically increasing entry number, added by HashChainFormatter",
      "title": "Sequence"
    },
    "prev_hash": {
      "anyOf": [
        {
          "type": "string"
        },
        {
          "type": "null"
        }
      ],
      "default": null,
      "description": "SHA-256 hash of previous entry, or 'GENESIS' for first entry",
      "title": "Prev Hash"
    },
    "entry_hash": {
      "anyOf": [
        {
          "type": "string"
        },
        {
          "type": "null"
        }
      ],
      "default": null,
      "description": "SHA-256 hash of this entry for chain verification",
      "title": "Entry Hash"
    },
    "event": {
      "const": "policy_decision",
      "default": "policy_decision",
      "title": "Event",
      "type": "string"
    },
    "decision": {
      "enum": [
        "allow",
        "deny",
        "hitl"
      ],
      "title": "Decision",
      "type": "string"
    },
    "hitl_outcome": {
      "anyOf": [
        {
          "enum": [
            "user_allowed",
            "user_denied",
            "timeout"
          ],
          "type": "string"
        },
        {
          "type": "null"
        }
      ],
      "default": null,
      "title": "Hitl Outcome"
    },
    "hitl_cache_hit": {
      "anyOf": [
        {
          "type": "boolean"
        },
        {
          "type": "null"
        }
      ],
      "default": null,
      "description": "True if approval was from cache, False if user prompted, None if not HITL",
      "title": "Hitl Cache Hit"
    },
    "hitl_approver_id": {
      "anyOf": [
        {
          "type": "string"
        },
        {
          "type": "null"
        }
      ],
      "default": null,
      "description": "OIDC subject ID of user who approved/denied (None if timeout or cache hit)",
      "title": "Hitl Approver Id"
    },
    "matched_rules": {
      "description": "All rules that matched, with effect and optional description for trace",
      "items": {
        "$ref": "#/$defs/MatchedRuleLog"
      },
      "title": "Matched Rules",
      "type": "array"
    },
    "final_rule": {
      "title": "Final Rule",
      "type": "string"
    },
    "mcp_method": {
      "title": "Mcp Method",
      "type": "string"
    },
    "tool_name": {
      "anyOf": [
        {
          "type": "string"
        },
        {
          "type": "null"
        }
      ],
      "default": null,
      "title": "Tool Name"
    },
    "path": {
      "anyOf": [
        {
          "type": "string"
        },
        {
          "type": "null"
        }
      ],
      "default": null,
      "title": "Path"
    },
    "source_path": {
      "anyOf": [
        {
          "type": "string"
        },
        {
          "type": "null"
        }
      ],
      "default": null,
      "title": "Source Path"
    },
    "dest_path": {
      "anyOf": [
        {
          "type": "string"
        },
        {
          "type": "null"
        }
      ],
      "default": null,
      "title": "Dest Path"
    },
    "uri": {
      "anyOf": [
        {
          "type": "string"
        },
        {
          "type": "null"
        }
      ],
      "default": null,
      "title": "Uri"
    },
    "scheme": {
      "anyOf": [
        {
          "type": "string"
        },
        {
          "type": "null"
        }
      ],
      "default": null,
      "title": "Scheme"
    },
    "subject_id": {
      "anyOf": [
        {
          "type": "string"
        },
        {
          "type": "null"
        }
      ],
      "default": null,
      "title": "Subject Id"
    },
    "backend_id": {
      "title": "Backend Id",
      "type": "string"
    },
    "side_effects": {
      "anyOf": [
        {
          "items": {
            "type": "string"
          },
          "type": "array"
        },
        {
          "type": "null"
        }
      ],
      "default": null,
      "title": "Side Effects"
    },
    "policy_version": {
      "title": "Policy Version",
      "type": "string"
    },
    "policy_eval_ms": {
      "title": "Policy Eval Ms",
      "type": "number"
    },
    "policy_hitl_ms": {
      "anyOf": [
        {
          "type": "number"
        },
        {
          "type": "null"
        }
      ],
      "default": null,
      "title": "Policy Hitl Ms"
    },
    "policy_total_ms": {
      "title": "Policy Total Ms",
      "type": "number"
    },
    "request_id": {
      "title": "Request Id",
      "type": "string"
    },
    "session_id": {
      "anyOf": [
        {
          "type": "string"
        },
        {
          "type": "null"
        }
      ],
      "default": null,
      "title": "Session Id"
    }
  },
  "required": [
    "decision",
    "final_rule",
    "mcp_method",
    "backend_id",
    "policy_version",
    "policy_eval_ms",
    "policy_total_ms",
    "request_id"
  ],
  "title": "DecisionEvent",
  "type": "object"
}
